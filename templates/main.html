<!DOCTYPE html>
<html lang='ru'>
<head>
    <meta charset="UTF-8">
    <title>Управление миссией</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f6f8;
            color: #333;
        }

        header h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        h2 {
            margin: 5px !important;
        }

        #status_panel {
            width: 600px;
            margin: 0 auto 0 auto;
            padding: 15px 20px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: white;
            border-radius: 10px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .status.ok {
            background-color: #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.6);
        }

        .status.running {
            background-color: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
        }

        .status.error {
            background-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.9);
            animation: blink 1s infinite;
        }

        .status.completed {
            background-color: #2471a3;
            box-shadow: 0 0 20px rgba(36, 113, 163, 0.9);
            animation: blink 1s infinite;
        }

        .status.return {
            background-color: #f39c12;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
        }

        @keyframes blink {
            0%   {
            filter: brightness(1);
            }
            50%  {
            filter: brightness(0.7);
            }
            100% {
            filter: brightness(1);
            }
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-left: 18px;
            margin-right: 18px;
        }

        button {
            padding: 12px 25px;
            border: none;
            color: white;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:hover:not(:disabled) {
            transform: scale(1.07);
            filter: brightness(90%);
        }

        img {
            width: 460px;
            height: auto;
        }

        #start {
            background-color: #27ae60;
        }
        #stop {
            background-color: #e67e22;
        }
        #kill_switch {
            background-color: #c0392b;
        }
        #break {
            background-color: #2980b9;
            margin-left: 20px;
        }

        .sect {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            margin-bottom: 25px;
        }

        .branches-container ul {
            list-style: none;
            padding: 0;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: white;
            width: 240px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<header>
    <h1>Управление миссией</h1>
</header>

<hr>

<section class='button-group'>
    <button id='start'>Старт</button>
    <button id='stop' disabled>Стоп</button>
    <button id='kill_switch' disabled>Kill switch</button>
    <button id='break'>Завершить программу</button>
</section>

<hr>

<div id='status_panel' class='status ok'>Готов</div>

<hr>

<section class='sect'>
    <div class='map-container'>
        <h2>Карта / Изображение</h2>
        <img id='map' src='/static/sample_image.jpg' alt='Карта миссии'>
    </div>

    <div class='branches-container'>
        <h2>Найденные врезки</h2>
        <ul id='branches_list'></ul>
    </div>
</section>

<hr>

<script>
    async function fetchBranches() {
        const response = await fetch('/update_coordinates');
        const branches = await response.json();
        const ul = document.getElementById('branches_list');
        ul.innerHTML = '';

        branches.forEach((branch, index) => {
            const li = document.createElement('li');
            if (branch !== null && typeof branch === 'object' && 'x' in branch && 'y' in branch) {
                li.textContent = `${index + 1}) x: ${branch.x}, y: ${branch.y}`;
            } else {
                li.textContent = `${index + 1}) None`;
            }

            ul.appendChild(li);
        }
        );
    }

    async function updateMap() {
        const response = await fetch('/update_map');
        const data = await response.json();
        const mapImg = document.getElementById('map');
        mapImg.src = `${data.img}?t=${new Date().getTime()}`;
    }

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const killBtn = document.getElementById('kill_switch');
    const breakBtn = document.getElementById('break');

    startBtn.addEventListener('click', async () => {
        setStatus('Выполнение', 'running');
        startBtn.textContent = 'Выполнение...';
        stopBtn.textContent = 'Стоп';
        killBtn.textContent = 'Kill switch';
        breakBtn.textContent = 'Завершить программу';
        startBtn.disabled = true;
        stopBtn.disabled = false;
        killBtn.disabled = false;
        breakBtn.disabled = false;
        await fetch('/status', { method: 'POST', body: 'execution'});
        await fetch('/start', { method: 'POST' });
    }
    );

    stopBtn.addEventListener('click', async () => {
        setStatus('Посадка', 'return');
        startBtn.textContent = 'Старт';
        stopBtn.textContent = 'Остановка...';
        killBtn.textContent = 'Kill switch';
        breakBtn.textContent = 'Завершить программу';
        startBtn.disabled = true;
        stopBtn.disabled = true;
        killBtn.disabled = true;
        breakBtn.disabled = false;
        await fetch('/status', { method: 'POST', body: 'stop'});
        await fetch('/stop', { method: 'POST' });
    }
    );

    killBtn.addEventListener('click', async () => {
        setStatus('АВАРИЯ', 'error');
        startBtn.textContent = 'Старт';
        stopBtn.textContent = 'Стоп';
        killBtn.textContent = 'Авария!';
        breakBtn.textContent = 'Завершено';
        startBtn.disabled = true;
        stopBtn.disabled = true;
        killBtn.disabled = true;
        breakBtn.disabled = true;
        await fetch('/status', { method: 'POST', body: 'accident'});
        await fetch('/kill_switch', { method: 'POST' });
    }
    );

    breakBtn.addEventListener('click', async () => {
        setStatus('Программа остановлена', 'completed');
        startBtn.textContent = 'Старт';
        stopBtn.textContent = 'Стоп';
        killBtn.textContent = 'Kill switch';
        breakBtn.textContent = 'Завершено';
        startBtn.disabled = true;
        stopBtn.disabled = true;
        killBtn.disabled = true;
        breakBtn.disabled = true;
        await fetch('/status', { method: 'POST', body: 'completed'});
        await fetch('/break', { method: 'POST' });
    }
    );


    async function checkMissionState() {
        const response = await fetch('/mission_state');
        const data = await response.json();
        if (data.mission === 'expectation') {
            setStatus('Готов', 'ok');
            startBtn.textContent = 'Старт';
            stopBtn.textContent = 'Стоп';
            killBtn.textContent = 'Kill switch';
            breakBtn.textContent = 'Завершить программу';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            killBtn.disabled = true;
            breakBtn.disabled = false;
            return;
        }
        if (data.mission === 'execution') {
            setStatus('Выполнение', 'running');
            startBtn.textContent = 'Выполнение...';
            stopBtn.textContent = 'Стоп';
            killBtn.textContent = 'Kill switch';
            breakBtn.textContent = 'Завершить программу';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            killBtn.disabled = false;
            breakBtn.disabled = false;
            return;
        }
        if (data.mission === 'stop') {
            setStatus('Посадка', 'return');
            startBtn.textContent = 'Старт';
            stopBtn.textContent = 'Остановка...';
            killBtn.textContent = 'Kill switch';
            breakBtn.textContent = 'Завершить программу';
            startBtn.disabled = true;
            stopBtn.disabled = true;
            killBtn.disabled = true;
            breakBtn.disabled = false;
            return;
        }
        if (data.mission === 'accident') {
            setStatus('АВАРИЯ', 'error');
            startBtn.textContent = 'Старт';
            stopBtn.textContent = 'Стоп';
            killBtn.textContent = 'Авария!';
            breakBtn.textContent = 'Завершено';
            startBtn.disabled = true;
            stopBtn.disabled = true;
            killBtn.disabled = true;
            breakBtn.disabled = true;
            return;
        }
        if (data.mission === 'completed') {
            setStatus('Программа остановлена', 'completed');
            startBtn.textContent = 'Старт';
            stopBtn.textContent = 'Стоп';
            killBtn.textContent = 'Kill switch';
            breakBtn.textContent = 'Завершено';
            startBtn.disabled = true;
            stopBtn.disabled = true;
            killBtn.disabled = true;
            breakBtn.disabled = true;
            return;
        }
    }

    const statusPanel = document.getElementById('status_panel');

    function setStatus(text, className) {
        statusPanel.textContent = text;
        statusPanel.className = 'status ' + className;
    }

    window.addEventListener('DOMContentLoaded', () => {
        fetchBranches();
        setInterval(fetchBranches, 500);
        setInterval(updateMap, 1000);
        setInterval(checkMissionState, 500);
    }
    );
</script>
</body>
</html>
